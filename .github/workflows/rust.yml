name: Rust

on:
  push:
    branches: ["master"]
    tags: ["v*"]
  pull_request:
    branches: ["master"]

env:
  CARGO_TERM_COLOR: always

jobs:
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust nightly
        run: rustup toolchain install nightly --profile minimal --component clippy
      - uses: Swatinem/rust-cache@v2
      - name: Run clippy
        run: cargo +nightly clippy --all-targets --all-features -- -D clippy::nursery -D clippy::all -D clippy::pedantic

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: Swatinem/rust-cache@v2
      - name: Build
        run: cargo build --verbose
      - name: Run tests
        run: cargo test --verbose

  msrv:
    name: MSRV (1.80.0)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust 1.80.0
        run: rustup toolchain install 1.80.0 --profile minimal
      - uses: Swatinem/rust-cache@v2
      - name: Build with MSRV
        run: cargo +1.80.0 build --verbose
      - name: Test with MSRV
        run: cargo +1.80.0 test --verbose

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install cargo-audit
        run: cargo install cargo-audit
      - name: Run security audit
        run: cargo audit

  release:
    name: Release Build
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [fmt, clippy, test, msrv, audit]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: rbasefind
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: rbasefind
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: rbasefind
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: rbasefind.exe
    steps:
      - uses: actions/checkout@v4
      - name: Install target
        run: rustup target add ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}
      - name: Build release
        run: cargo build --release --target ${{ matrix.target }}
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rbasefind-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/${{ matrix.artifact }}
